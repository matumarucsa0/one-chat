<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="/static/index.css">
        <title>Home</title>
        <script src="/static/gif.js" defer></script>

        
    </head>
    <script>
        function on_load(){
            document.getElementById('anchor').scrollIntoView(true);
            document.getElementById('overlay').style.display = "none";
        }
    </script>
    <body onload="on_load()">
        <div id="overlay"></div>

        <div id="overlay-user-profile" onclick="hide_profile()"></div>
        <div class="about_profile" id="about_profile">
            <div id="banner">
                <img class="profile-picture-" id="about_profile-img">
            </div>
            <br>
            <div class="profile--">
                <h1 class="name" id="about_profile-name"></h1>
                <div class="br"></div>
                <p class="about">ABOUT ME</p>
                <p class="about-text" id="about_profile-about">
                    
                </p> <!-- 263 characters max -->
            </div>
        </div>
        
        <div class="account">
            <a href="/t" style="position: fixed; right: 4%; top: 2%;">
                <div class="emote-container">
                    <img class="profile-pic-message" src="/static/profile-pic/{{profile_pic}}">
                </div>
            </a>
        </div>

        <div id="overlay2" onclick="close_get_users()"></div>

        <div id="add-chat-box">
            <div class="add-chat-top">
                <input placeholder="Find User...">
            </div>
            <div class="add-chat-bottom" id="search-users-div">
                
            </div>
        </div>
        
        <div class="{% if group.group %}main-div-group{% else %}main-div{% endif %}">
            <div class="side-bar">
                <button class="add-chat" onclick="get_users_direct()">Add chat</button>
                <button class="add-chat" onclick="get_users_group()">Add group</button>
                {% for r in rooms %}
                    <a {% if r[0]|string != 'room' %}href="/room/{{r[0]}}"{% endif %} style="display: block;" >
                        <div class="{% if r[0]|string == room %}chat-selected{% else %}chat-select{% endif %}">
                            <section style="position: relative;">
                                <img src="{{r[2]}}">
                                {% if r[3]|string == 'direct-chat' %}
                                <svg style="position:absolute;" width="10" height="10" >
                                    <circle r="5" cx="5" cy="5" fill="#F23F43" user_id="{{r[4]}}" class="stat"></circle>
                                </svg>
                                {% endif %}
                            </section>
                            {% if r[3]|string == 'direct-chat' %}
                            <div><p>{{r[1]}}</p></div>
                            {% else %}
                                <div style="padding-top: 5px;">
                                    <p>{{r[1]}}</p>
                                    <p class="user-amount">{{group_user_amount[r[0]]}} Members</p>
                                </div>
                            {% endif%}
                        </div>
                    </a>
                {% endfor %}

            </div>
            <div class="main-">
                
                <div class="messages" id="massage_box" style="height: calc(100vh - 102.65625px);">
                    {% for message in messages %}
                        {% if message["status"] =="child" %}
                            <div class="message" style="margin-bottom: 0;" child="">
                                <div></div>
                                {% if "image_src" in message %}
                                            <img style="max-width: 300px; max-height: 300px; margin-top: 4px; margin-bottom: 4px;" src="{{message['image_src']}}">
                                {% else %}
                                    <div class="text-bottom" style="margin-top: 4px;">
                                        {% if "only-emote" in message %}
                                        {%for content in message["message_content"]%}
                                            {% if "img--" in content %}
                                                    <img style="max-width: 50px; max-height: 50px; display: inline-block; vertical-align: middle;" src="/static/emotes/{{content[5:]}}">
                                            {% else %}
                                                <p style="display: inline-block; margin-top: 0px; margin-bottom: 0px; ">{{content}}</p>
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        {%for content in message["message_content"]%}
                                            {% if "img--" in content %}
                                                    <img style="max-width: 22px; max-height: 22px; display: inline-block; vertical-align: middle;" src="/static/emotes/{{content[5:]}}">
                                            {% else %}
                                                <p style="display: inline-block; margin-top: 0px; margin-bottom: 0px; ">{{content}}</p>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            {% if message["status"] == "parent" %}
                                <div class="message" style="margin-bottom: 0;">
                                    <div class="emote-container">
                                        <img class="profile-pic-message" src="/static/profile-pic/{{message['profile_picture']}}" onclick="show_profile('{{message.user_id}}')">
                                    </div>
                                    <div>
                                        <p class="text-top">{{message["username"]}}  {{message["date"]}}</p>
                                        
                                        {% if "image_src" in message %}
                                            <img style="max-width: 300px; max-height: 300px" src="{{message['image_src']}}">
                                        {% else %}
                                            <div class="text-bottom">
                                                {% if "only-emote" in message %}
                                                    {%for content in message["message_content"]%}
                                                        {% if "img--" in content %}
                                                                <img style="max-width: 50px; max-height: 50px; display: inline-block; vertical-align: middle;" src="/static/emotes/{{content[5:]}}">
                                                        {% else %}
                                                            <p style="display: inline-block; margin-top: 0px; margin-bottom: 0px; ">{{content}}</p>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% else %}
                                                    {%for content in message["message_content"]%}
                                                        {% if "img--" in content %}
                                                                <img style="max-width: 22px; max-height: 22px; display: inline-block; vertical-align: middle;" src="/static/emotes/{{content[5:]}}">
                                                        {% else %}
                                                            <p style="display: inline-block; margin-top: 0px; margin-bottom: 0px; ">{{content}}</p>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% else %}
                                <div class="message">
                                    <div class="emote-container">
                                        <img  class="profile-pic-message" src="/static/profile-pic/{{message['profile_picture']}}" onclick="show_profile('{{message.user_id}}')">
                                    </div>
                                    <div>
                                        <p class="text-top">{{message["username"]}}  {{message["date"]}}</p>
                                        
                                        {% if "image_src" in message %}
                                            <img style="max-width: 300px; max-height: 300px" src="{{message['image_src']}}">
                                        {% else %}
                                            <div class="text-bottom">
                                                {% if "only-emote" in message %}
                                                    {%for content in message["message_content"]%}
                                                        {% if "img--" in content %}
                                                                <img style="max-width: 50px; max-height: 50px; display: inline-block; vertical-align: middle;" src="/static/emotes/{{content[5:]}}">
                                                        {% else %}
                                                            <p style="display: inline-block; margin-top: 0px; margin-bottom: 0px; ">{{content}}</p>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% else %}
                                                    {%for content in message["message_content"]%}
                                                        {% if "img--" in content %}
                                                                <img style="max-width: 22px; max-height: 22px; display: inline-block; vertical-align: middle;" src="/static/emotes/{{content[5:]}}">
                                                        {% else %}
                                                            <p style="display: inline-block; margin-top: 0px; margin-bottom: 0px; ">{{content}}</p>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}
                        {% endif %}
                    {% endfor %}

                    

                    <div id="anchor"></div>
                </div>

                <div class="send" id="send">
                    <div class="box" id="box" style="max-width: 75vw;">
                        <div contenteditable id="post-content" class="text-input" style="max-width: 480px; position: relative;"></div>
                        <p id="is_typing_element">HEY</p>
                        <div class="dropup2">
                            <button onclick="dropup('dropup-content2', 'dropup-content')" class="dropbtn2">Gif</button>
                            <div class="dropup-content2" id="dropup-content2" style="display: none;">
                                <div class="top-bar">
                                    <div class="top-bar-selection">
                                        <button class="top-bar-button-active">gifs</button>
                                        <button onclick="dropup('dropup-content', 'dropup-content2')">emotes</button>
                                    </div>
                                    <div class="top-bar-search">
                                        <div class="top-bar-search-bar">
                                            <input id="gif-search" oninput="render_gif()" autocomplete="off">
                                            <svg class="icon-18rqoe" aria-hidden="true" role="img" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M21.707 20.293L16.314 14.9C17.403 13.504 18 11.799 18 10C18 7.863 17.167 5.854 15.656 4.344C14.146 2.832 12.137 2 10 2C7.863 2 5.854 2.832 4.344 4.344C2.833 5.854 2 7.863 2 10C2 12.137 2.833 14.146 4.344 15.656C5.854 17.168 7.863 18 10 18C11.799 18 13.504 17.404 14.9 16.314L20.293 21.706L21.707 20.293ZM10 16C8.397 16 6.891 15.376 5.758 14.243C4.624 13.11 4 11.603 4 10C4 8.398 4.624 6.891 5.758 5.758C6.891 4.624 8.397 4 10 4C11.603 4 13.109 4.624 14.242 5.758C15.376 6.891 16 8.398 16 10C16 11.603 15.376 13.11 14.242 14.243C13.109 15.376 11.603 16 10 16Z"></path></svg>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div id="gif-container" style="height: 400px; overflow-y: scroll;"></div>
                                </div>
                            </div>
                        
                            <button onclick="dropup('dropup-content', 'dropup-content2')" class="dropbtn">Emotes</button>
                            <div class="dropup-content" id="dropup-content" style="display: none;">
                                <div class="top-bar">
                                    <div class="top-bar-selection">
                                        <button onclick="dropup('dropup-content2', 'dropup-content')">gifs</button>
                                        <button class="top-bar-button-active">emotes</button>
                                    </div>
                                    <div class="top-bar-search">
                                        <div class="top-bar-search-bar">
                                            <input autocomplete="off" id="top-bar-search-input">
                                            <svg class="icon-18rqoe" aria-hidden="true" role="img" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M21.707 20.293L16.314 14.9C17.403 13.504 18 11.799 18 10C18 7.863 17.167 5.854 15.656 4.344C14.146 2.832 12.137 2 10 2C7.863 2 5.854 2.832 4.344 4.344C2.833 5.854 2 7.863 2 10C2 12.137 2.833 14.146 4.344 15.656C5.854 17.168 7.863 18 10 18C11.799 18 13.504 17.404 14.9 16.314L20.293 21.706L21.707 20.293ZM10 16C8.397 16 6.891 15.376 5.758 14.243C4.624 13.11 4 11.603 4 10C4 8.398 4.624 6.891 5.758 5.758C6.891 4.624 8.397 4 10 4C11.603 4 13.109 4.624 14.242 5.758C15.376 6.891 16 8.398 16 10C16 11.603 15.376 13.11 14.242 14.243C13.109 15.376 11.603 16 10 16Z"></path></svg>
                                        </div>
                                    </div>
                                </div>
                                <div style="overflow-y: scroll; height: 400px;">
                                    {% for emote in emotes %}
                                        <li style="width: 50px; height: 50px;">
                                            <img loading="lazy" onclick="add_emote('{{emote}}')" src="/static/emotes/{{emote}}" style="max-width: 50px; max-height: 50px; margin: 0 auto; display: block;">
                                        </li>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        
                    </div>
                </div>
            </div>
            {% if group.group %}
                <div>
                    
                    {% for user in group.users %}
                        <div class="chat-select">
                            <section style="position: relative;">
                                <img src="/static/profile-pic/{{user[2]}}">
                                <svg style="position:absolute;" width="10" height="10" >
                                    <circle r="5" cx="5" cy="5" fill="#F23F43" user_id="{{user[0]}}" class="stat"></circle>
                                </svg>
                            </section>
                            
                            <div>
                                <p>{{user[1]}}</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
           {% endif %}
        </div>
    </body>

    <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="//cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <script>
        const room = "{{room}}"
        console.log(room)

        const element = document.querySelector("#post-content");

        // Create a new ResizeObserver
        const resizeObserver = new ResizeObserver(entries => {
        // Loop through the entries
        entries.forEach(entry => {
            // Log the new size of the element
            is_attach = document.getElementById("attach")
            if (is_attach){
                document.getElementById("massage_box").setAttribute("style", "height: calc(100vh - "+(entry.contentRect.height + 102.656+ 250)+"px);")
            }
            else{
                document.getElementById("massage_box").setAttribute("style", "height: calc(100vh - "+(entry.contentRect.height + 102.656)+"px);")
            }

            document.getElementById('anchor').scrollIntoView(true);
        });
        });
        
        if (element) {
            // Observe the element
            resizeObserver.observe(element);
        } 
        else {
            console.error('Element not found');
        }

        async function show_profile(id){
            const response = await fetch('/user_profile/'+id);
            const data = await response.json();

            document.getElementById("banner").setAttribute("style", 'padding-top: 10px; padding-bottom: 10px; background-color: ' + data['banner_color'] + '; border-color: ' + data['banner_color'] +';')
            document.getElementById("about_profile-img").setAttribute("src", "/static/profile-pic/" + data['profile_pic'])
            document.getElementById("about_profile-name").innerHTML = data['username']
            document.getElementById("about_profile-about").innerHTML = data['about_me']

            document.getElementById("about_profile").style.display = "block"
            document.getElementById("overlay-user-profile").style.display = "block"
        }

        function hide_profile(){
            document.getElementById("about_profile").style.display = "none"
            document.getElementById("overlay-user-profile").style.display = "none"
        }
        
        

        function dropup(id, other_id){
            var dropup =  document.getElementById(id)
            var other_dropup = document.getElementById(other_id)
            if (dropup.style.display == "none"){
                dropup.style.display = "block"
                other_dropup.style.display = "none"

            }
            else{
                dropup.style.display = "none"
            }
        }

        function add_emote(emote_id){
            document.getElementById("post-content").innerHTML += "<img src='/static/emotes/"+emote_id+"'>&nbsp;"
        }



        function resizeImage(base64Str) {
            var img = new Image();
            img.src = base64Str;
            var canvas = document.createElement('canvas');
            var MAX_WIDTH = 400;
            var MAX_HEIGHT = 350;
            var width = img.width;
            var height = img.height;

            if (width > height) {
            if (width > MAX_WIDTH) {
            height *= MAX_WIDTH / width;
            width = MAX_WIDTH;
            }
            } else {
            if (height > MAX_HEIGHT) {
            width *= MAX_HEIGHT / height;
            height = MAX_HEIGHT;
            }
            }
            canvas.width = width;
            canvas.height = height;
            var ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            return canvas.toDataURL();
        }


        const user = "{{username}}"
        const user_id = "{{user_id}}"

        var socket = io();

        socket.emit("onload", {"user_id": user_id})

        

        //scrooll
        var anchor = document.getElementById("anchor")
        anchor.scrollIntoView(true)

        //on recieved massage
        

        //send massage
        
        val_e = document.getElementById("post-content")
        val_e.focus()

        const PROFILE_PICTURE = "{{profile_pic}}"

        document.addEventListener("keydown", function(event){
            
            if (event.keyCode == 13){
                event.preventDefault()
                
                
                if (val_e.innerHTML != "" || document.getElementById("attach") != null) {
                    //check if image is in attachments
                    if (document.getElementById("attach") != null){

                        

                        
                        var img_attach = document.getElementById("image-attachment").getAttribute("src")
                        img_attach = resizeImage(img_attach)

                        socket.emit("post--",{attach: img_attach,username: user, user_id : user_id, chat : val_e.innerHTML, profile_pic : "{{profile_pic}}", room: room});
                        
                        document.getElementById("attach").remove()
                        v = Number(document.getElementById("massage_box").style.height.split("vh - ")[1].split("px")[0]) - 250
                        document.getElementById("massage_box").setAttribute("style", "height: calc(100vh - " + v +"px);") //"height: calc(100vh - "+(entry.contentRect.height + 102.656)+"px);"
                        document.getElementById("post-content").setAttribute("style", "")
                        val_e.focus()
                    }
                    else{
                        
                        socket.emit("post--",{username: user, user_id : user_id, chat : val_e.innerHTML, profile_pic : "{{profile_pic}}", room:room});
                    }
                    
                    val_e.innerHTML = "";
                    val_e.focus()
                }
                
            } 
        })
        
        function insertTextAtCursor(text) {
            var sel, range, textNode;
            if (window.getSelection) {
                sel = window.getSelection();
                if (sel.getRangeAt && sel.rangeCount) {
                range = sel.getRangeAt(0);
                textNode = document.createTextNode(text);
                range.insertNode(textNode);
                range.setStartAfter(textNode);
                sel.removeAllRanges();
                sel.addRange(range);
                }
            }
        }
        
        // paste image handeling
        const chatInput = document.getElementById('post-content');

        chatInput.addEventListener('paste', function(e) {
            e.preventDefault();
            var items = (e.clipboardData || e.originalEvent.clipboardData).items;
            var isImage = false;
            for (var i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') === 0) {
                    // This is an image
                    
                    
                    if (document.getElementById("attach") == null){
                        var imageFile = items[i].getAsFile();
                        var reader = new FileReader();
                        reader.onload = function(event) {
                            var img = new Image();
                            img.src = event.target.result;
                            img.setAttribute("class", "image-attachment")
                            img.setAttribute("id", "image-attachment")
                            
                            //change the messages size
                            
                            
                            height_of_send = Number(document.getElementById("massage_box").style.height.split("vh - ")[1].split("px")[0]) + 250
                            document.getElementById("massage_box").setAttribute("style", "height: calc(100vh - " + height_of_send +"px);")
                            

                            //create attachment menu
                            var d  = document.createElement('div')
                            d.setAttribute('class', 'image-attachment-box')
                            d.setAttribute('id', 'attach')
                            document.getElementById("send").insertBefore(d, document.getElementById("box"))
                            d.appendChild(img)
                            
                            //document.getElementById("massage_box").setAttribute("style", "height: calc(90vh - 39vh);")

                            //change the radius
                            document.getElementById("post-content").setAttribute("style", "border-top-right-radius: 0; border-top-left-radius: 0;")

                            //scroll down after the box creation
                            var anchor = document.getElementById("anchor")
                            anchor.scrollIntoView(true)

                            //create close button
                            var close = document.createElement("button")
                            close.setAttribute("id", "close-button")
                            close.innerHTML = "close"
                            d.appendChild(close)
                            close.addEventListener("click", function () {
                                v = Number(document.getElementById("massage_box").style.height.split("vh - ")[1].split("px")[0]) - 250
                                document.getElementById("massage_box").setAttribute("style", "height: calc(100vh - " + v +"px);") //"height: calc(100vh - "+(entry.contentRect.height + 102.656)+"px);"
                                
                                d.remove()
                                document.getElementById("post-content").setAttribute("style", "")
                                val_e.focus()
                            })
                        };
                    }
                    else{
                        alert("Only one image")
                    }

                    
                    reader.readAsDataURL(imageFile);
                    isImage = true;
                    break;
                    }
                    
                    
            }
            if (!isImage) {
                
                // Insert the pasted text as plain text
                const text = event.clipboardData.getData('text/plain');
                insertTextAtCursor(text)
            }
            });

    </script>
    <script src="/static/recieve.js"></script>
    <script src="/static/add_chat.js"></script>
    <script src="/static/status.js"></script>
</html>